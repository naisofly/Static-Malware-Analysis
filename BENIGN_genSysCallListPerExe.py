import os
import sys
import hashlib
import pefile

walk_dir = sys.argv[1]  # folder with MASTIFF generated files for each binary

print('walk_dir = ' + walk_dir)

# If your current working directory may change during script execution, it's recommended to
# immediately convert program arguments to an absolute path. Then the variable root below will
# be an absolute path as well. Example:
walk_dir = os.path.abspath(walk_dir)
print('walk_dir (absolute) = ' + os.path.abspath(walk_dir))


cnt = 0

for root, subdirs, files in os.walk(walk_dir):
    list_file_path = os.path.join(root, '')

    cnt += 1
    for filename in files:  # 58,856 found out of 63,628
        file_path = os.path.join(root, filename)
        mdhash = hashlib.md5(open(file_path, 'rb').read()).hexdigest()
        try:
            pe = pefile.PE(file_path)

            for entry in pe.DIRECTORY_ENTRY_IMPORT:
                # print entry.dll
                for imp in entry.imports:
                    with open("/home/tarun/Desktop/DLL/SysCalls/" + mdhash + ".txt", 'a') as w:
                        w.write(imp.name + '\n')

        except Exception as e:
            print str(e), " Error for file: ", mdhash
            with open("/home/tarun/Desktop/DLL/SysCalls/" + mdhash + ".txt", 'a') as w:
                w.write('\n')

    print cnt  #print number of files created
