options(java.parameters = "- Xmx16000m")
library(caret)
library(randomForest)
library(pROC)

# output = oepSubMatrix_250[,ncol(oepSubMatrix_250)]
subMatrix_oep_folds = createFolds(oepSubMatrix_250[,ncol(oepSubMatrix_250)], k = 10, list = TRUE, returnTrain = FALSE)

# prediction and testset data frames that we add to with each iteration over
# the folds

prediction <- data.frame()
testsetCopy <- data.frame()

#Creating a progress bar to know the status of CV
progress_total <- 10
# create progress bar
pb <- txtProgressBar(min = 0, max = progress_total, style = 3)


for(i in 1:10){
	iFoldName = names(subMatrix_oep_folds)[i]
	names(subMatrix_oep_folds)[i] <- "test"
	testData <- oepSubMatrix_250[subMatrix_oep_folds$test,]
	trainData <- oepSubMatrix_250[-subMatrix_oep_folds$test,]
	# cat("\nTraining: ", dim(trainData))
	# cat("\nIndices: ", str(-subMatrix_oep_folds$test))
	# cat("\nTesting: ", dim(testData))
	# cat("\nIndices: ", str(subMatrix_oep_folds$test))
	outputCol = trainData[,ncol(trainData)] # output column of training matrix containing 1 if malware or 0 if benign; for matching variable length while comparing formula & data params
	rf_model <- randomForest(	formula = as.factor(outputCol) ~ .,	data = trainData, ntree = 200, mtry = 46, importance = TRUE, 
								replace = FALSE, na.action = randomForest::na.roughfix) #na replaced by median values #na.action = na.omit) 
	
	cat("\n\nIteration =================================================>", i)
	print(rf_model)

	# remove response column output, Sepal.Length - output column
	  temp <- as.data.frame(predict(rf_model, output = testData[,-ncol(testData)]))
	  # append this iteration's predictions to the end of the prediction data frame
	  prediction <- rbind(prediction, temp)
	  
	  # append this iteration's test set to the test set copy data frame
	  # keep only the Sepal Length Column -output column
	  testsetCopy <- rbind(testsetCopy, as.data.frame(testData[,ncol(testData)]))
	  str(testsetCopy)
	# prediction <- predict(rf_model, testData, type="response") # type="prob"
	# rf_roc <- roc(response = rf_model$y, predictor = as.numeric(prediction)) #draw roc curve
	# plot(rf_roc, print.thres="best", print.thres.best.method="closest.topleft")

	# rf_coords <- coords(rf_roc, "best", best.method="closest.topleft", ret=c("threshold", "accuracy"))
	# print(rf_coords)#to get threshold and accuracy


	setTxtProgressBar(pb, i)
}
close(pb)

# add predictions and actual Sepal Length values
result <- cbind(prediction, output = testsetCopy[,ncol(testsetCopy)])
# result <- cbind(prediction[1:73780,], output = testsetCopy[,ncol(testsetCopy)])
names(result) <- c("Predicted", "Actual")
result$Difference <- abs(result$Actual - result$Predicted)

# As an example use Mean Absolute Error as Evalution 
summary(result$Difference)

	# names(subMatrix_oep_folds)[i] <- iFoldName


# roc(response = rf_model$y, predictor = as.numeric(rf_model$predicted))